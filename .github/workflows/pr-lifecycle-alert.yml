name: PR Lifecycle Notifier

on:
  pull_request:
    types:
      - opened
      - review_requested
      - review_submitted
      - closed
      - reopened
      - synchronize

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install jq

      - name: Send PR Event Notification
        env:
          # ê³µí†µ ì±„ë„ Webhook
          DISCORD_WEBHOOK_ALL: ${{ secrets.DISCORD_WEBHOOK_ALL }}

          # íŒ€ì› ì±„ë„ Webhook + Discord ID
          DISCORD_WEBHOOK_GYUJIN: ${{ secrets.DISCORD_WEBHOOK_GYUJIN }}
          DISCORD_ID_GYUJIN: ${{ secrets.DISCORD_ID_GYUJIN }}

          DISCORD_WEBHOOK_MINHA: ${{ secrets.DISCORD_WEBHOOK_MINHA }}
          DISCORD_ID_MINHA: ${{ secrets.DISCORD_ID_MINHA }}

          DISCORD_WEBHOOK_JAEYOUNG: ${{ secrets.DISCORD_WEBHOOK_JAEYOUNG }}
          DISCORD_ID_JAEYOUNG: ${{ secrets.DISCORD_ID_JAEYOUNG }}

          DISCORD_WEBHOOK_SOLJI: ${{ secrets.DISCORD_WEBHOOK_SOLJI }}
          DISCORD_ID_SOLJI: ${{ secrets.DISCORD_ID_SOLJI }}

          DISCORD_WEBHOOK_WOOJOO: ${{ secrets.DISCORD_WEBHOOK_WOOJOO }}
          DISCORD_ID_WOOJOO: ${{ secrets.DISCORD_ID_WOOJOO }}
        run: |
          REVIEWER=$(jq -r '.requested_reviewer.login // empty' "$GITHUB_EVENT_PATH")
          AUTHOR=$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH")
          PR_TITLE=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
          PR_URL=$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")
          ACTION=$(jq -r '.action' "$GITHUB_EVENT_PATH")
          MERGED=$(jq -r '.pull_request.merged // false' "$GITHUB_EVENT_PATH")
          
          echo "ğŸ¯ ì´ë²¤íŠ¸: $ACTION / ë³‘í•© ì—¬ë¶€: $MERGED"
          echo "ì‘ì„±ì: $AUTHOR / ë¦¬ë·°ì–´: $REVIEWER"

          # ì±„ë„ ë§¤í•‘ í•¨ìˆ˜
          getUserInfo() {
            case "$1" in
              "notmybussiness") echo "$DISCORD_ID_GYUJIN|$DISCORD_WEBHOOK_GYUJIN" ;;
              "100gammmit") echo "$DISCORD_ID_MINHA|$DISCORD_WEBHOOK_MINHA" ;;
              "BeigeBearDev") echo "$DISCORD_ID_JAEYOUNG|$DISCORD_WEBHOOK_JAEYOUNG" ;;
              "solji-choi") echo "$DISCORD_ID_SOLJI|$DISCORD_WEBHOOK_SOLJI" ;;
              "universechoi") echo "$DISCORD_ID_WOOJOO|$DISCORD_WEBHOOK_WOOJOO" ;;
              *) echo "|";;
            esac
          }

          sendMessage() {
            WEBHOOK_URL="$1"
            CONTENT="$2"
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"$CONTENT\"}" "$WEBHOOK_URL"
          }

          # ê³µí†µ ì±„ë„ ë©”ì‹œì§€
          COMMON_MESSAGE=""
          case "$ACTION" in
            "opened")
              COMMON_MESSAGE="ğŸ“Œ [PR ìƒì„±] [$PR_TITLE]($PR_URL)\nì‘ì„±ì: \`$AUTHOR\`"
              ;;
            "review_requested")
              COMMON_MESSAGE="ğŸ“ [ë¦¬ë·° ìš”ì²­] [$PR_TITLE]($PR_URL)\nì‘ì„±ì: \`$AUTHOR\` â†’ ë¦¬ë·°ì–´: \`$REVIEWER\`"
              ;;
            "review_submitted")
              STATE=$(jq -r '.review.state' "$GITHUB_EVENT_PATH")
              COMMON_MESSAGE="âœ… [ë¦¬ë·° ì™„ë£Œ] [$PR_TITLE]($PR_URL)\në¦¬ë·°ì–´: \`$REVIEWER\` â†’ ìƒíƒœ: *$STATE*"
              ;;
            "closed")
              if [ "$MERGED" = "true" ]; then
                COMMON_MESSAGE="ğŸ‰ [PR ë¨¸ì§€ë¨] [$PR_TITLE]($PR_URL)\nì‘ì„±ì: \`$AUTHOR\`"
              else
                COMMON_MESSAGE="âŒ [PR ë‹«í˜] [$PR_TITLE]($PR_URL)\nì‘ì„±ì: \`$AUTHOR\`"
              fi
              ;;
            "synchronize")
              COMMON_MESSAGE="ğŸ”„ [PR ì—…ë°ì´íŠ¸] [$PR_TITLE]($PR_URL)\nì‘ì„±ì: \`$AUTHOR\`"
              ;;
          esac

          if [ -n "$COMMON_MESSAGE" ]; then
            sendMessage "$DISCORD_WEBHOOK_ALL" "$COMMON_MESSAGE"
          fi

          # ë¦¬ë·°ì–´ ë©˜ì…˜ (review_requested)
          if [ "$ACTION" = "review_requested" ]; then
            IFS='|' read -r DISCORD_ID WEBHOOK <<< "$(getUserInfo "$REVIEWER")"
            [ -n "$DISCORD_ID" ] && sendMessage "$WEBHOOK" "<@$DISCORD_ID> ë‹˜, ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ğŸ””\nğŸ‘‰ [$PR_TITLE]($PR_URL)"
          fi

          # ì‘ì„±ì ë©˜ì…˜ (review_submitted, closed/merged)
          if [[ "$ACTION" = "review_submitted" || "$ACTION" = "closed" ]]; then
            IFS='|' read -r DISCORD_ID WEBHOOK <<< "$(getUserInfo "$AUTHOR")"

            if [ -n "$DISCORD_ID" ]; then
              if [ "$ACTION" = "review_submitted" ]; then
                STATE=$(jq -r '.review.state' "$GITHUB_EVENT_PATH")
                sendMessage "$WEBHOOK" "<@$DISCORD_ID> ë‹˜, ë¦¬ë·°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ…\nìƒíƒœ: *$STATE*\nğŸ‘‰ [$PR_TITLE]($PR_URL)"
              elif [ "$ACTION" = "closed" ]; then
                if [ "$MERGED" = "true" ]; then
                  sendMessage "$WEBHOOK" "ğŸ‰ <@$DISCORD_ID> ë‹˜, PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!\nğŸ‘‰ [$PR_TITLE]($PR_URL)"
                else
                  sendMessage "$WEBHOOK" "âš ï¸ <@$DISCORD_ID> ë‹˜, PRì´ ë‹«í˜”ìŠµë‹ˆë‹¤ (ë³‘í•©ë˜ì§€ ì•ŠìŒ)\nğŸ‘‰ [$PR_TITLE]($PR_URL)"
                fi
              fi
            fi
          fi
