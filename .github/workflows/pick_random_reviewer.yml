name: "Pick Random Reviewer"

on:
  pull_request:
    types:
      - opened
    branches:
      - dev

jobs:
  pick-random-reviewer:
    runs-on: ubuntu-latest
    steps:
      # 1. Repository ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v2

      # 2. JavaScriptë¡œ ë¬´ì‘ìœ„ 2ëª…ì˜ ë¦¬ë·°ì–´ ì„ íƒ (PR ì‘ì„±ì ì œì™¸)
      - name: pick_random_reviewer
        id: pick_random_reviewer
        uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prAuthor = context.payload.pull_request.user.login;
            const candidate = ['100gammmit', 'BeigeBearDev', 'universechoi', 'notmybussiness', 'solji-choi'];
            const filteredCandidates = candidate.filter(username => username !== prAuthor);
            
            if (filteredCandidates.length < 2) {
              const comment = `ì„ íƒí•  ìˆ˜ ìˆëŠ” ë¦¬ë·°ì–´ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
              core.setOutput('comment', comment);
              core.setOutput('reviewers', '');
            } else {
              function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
              }
            
              const shuffledCandidates = shuffle(filteredCandidates);
              const selectedReviewers = shuffledCandidates.slice(0, 2);
              const comment = `ğŸ‰ @${selectedReviewers.join(', @')} ë‹˜ ëœë¤ ë¦¬ë·°ì–´ë¡œ ì„ ì •ë˜ì…¨ìŠµë‹ˆë‹¤! ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ğŸ™`;
              core.setOutput('comment', comment);
              core.setOutput('reviewers', selectedReviewers.join(','));
            }

      # 3. PRì— ëŒ“ê¸€ ì¶”ê°€
      - name: comment PR
        uses: mshick/add-pr-comment@v1
        with:
          message: ${{ steps.pick_random_reviewer.outputs.comment }}
          repo-token: ${{ secrets.GH_TOKEN }}
          repo-token-user-login: 'github-actions[bot]'

      # 4. ì„ íƒëœ ë¦¬ë·°ì–´ë¥¼ PR ë¦¬ë·°ì–´ë¡œ ì¶”ê°€
      - name: Add Pull Request Reviewer
        uses: madrapps/add-reviewers@v1
        with:
          reviewers: ${{ steps.pick_random_reviewer.outputs.reviewers }}
          token: ${{ secrets.GH_TOKEN }}
